(function(document){var calculate_aspect_ratio=function(width,height){return height/width},get_height_from_width=function(width,aspect_ratio){return Math.round(width*aspect_ratio)},get_width_from_height=function(height,aspect_ratio){return Math.round(height/aspect_ratio)},Croppy=function(files,element,config){if(this.instances=[],!this._can_cut_the_mustard())throw"Browser does not cut the mustard - cannot continue";this._set_el(element),this.config=_.extend({width:this.$el.width()},config),[].forEach.call(files,function(file){file.type.match("image.*")&&this._readFile(file)},this)};Croppy.prototype={_can_cut_the_mustard:function(){return window.FileReader?!0:!1},_readFile:function(file){if(!window.FileReader)throw"Browser does not support fileReader - cannot continue";var reader=new FileReader;reader.onload=this._onFileLoaded.bind(this),reader.readAsDataURL(file)},_onFileLoaded:function(e){var img=document.createElement("img");img.src=e.target.result,img.onload=function(){var instance=new Wrapper(img,this.config);this.$el.append(instance.$el),this.instances.push(instance)}.bind(this)},_set_el:function(element){if(!element)throw"Parent dom container is not defined";this.$el=element instanceof $?element:$(element)}};var Wrapper=function(img,config){return this.ui=new UI,this.canvas=new Canvas(img,config),this.createEl(),this.render(),this.addListeners(),this};Wrapper.fn=_.extend(Wrapper.prototype,Eventable,{createEl:function(){this.$el=$("<div>",{"class":"croppy__instance"})},render:function(){this.$el.append(this.ui.$el,this.canvas.$el)},addListeners:function(){_.forEach(this.ui.items,function(action){this.listenTo(this.ui,"ui:"+action,_.bind(this.canvas.actions[action],this.canvas))},this)}});var letterbox={horizontal:{_reset_canvas_height_with_letterbox:function(){this.el.height=this.canvas_size.height+=this.max_mask_size},_set_image_size:function(){this.image_size={width:this.canvas_size.width,height:this.image_size.height}},_set_letterbox_coordinates:function(){this.letterbox_coordinates=[[0,0,this.canvas_size.width,this.half_mask_size],[0,this.canvas_size.height-this.half_mask_size,this.canvas_size.width,this.half_mask_size]]},_set_crop_window_coordinates:function(){this.crop_window=[0,this.half_mask_size,this.canvas_size.width,this.canvas_size.height-this.half_mask_size]}},vertical:{_reset_canvas_height_with_letterbox:function(){this.el.height=this.canvas_size.height=this.get_height_from_width(this.canvas_size.width-this.max_mask_size,this.aspect_ratio)},_set_image_size:function(){this.image_size={width:this.get_width_from_height(this.canvas_size.height,this.image_ratio),height:this.canvas_size.height}},_set_letterbox_coordinates:function(){this.letterbox_coordinates=[[0,0,this.half_mask_size,this.canvas_size.height],[this.canvas_size.width-this.half_mask_size,0,this.half_mask_size,this.canvas_size.height]]},_set_crop_window_coordinates:function(){this.crop_window=[this.half_mask_size,0,this.canvas_size.width-this.half_mask_size,this.canvas_size.height]}},none:{_set_crop_window_coordinates:function(){this.crop_window=[0,0,this.canvas_size.width,this.canvas_size.height]},_set_image_size:function(){}}},Canvas=function(img,config){this.config=_.extend(this.config,config),this.zoom_level=0,this.rotation_angle=0,this._set_img(img),this._set_orientation_from_config(),this._set_el(),this._set_ctx(),this._set_common_properties(),this._set_mouse_events("on"),this.draw_with_rotation(this.origin)};Canvas.prototype={zoom_amount:10,config:{aspect_ratio:"16:9",max_mask_size:160},_set_common_properties:function(){this._set_aspect_ratio_from_config(),this._set_canvas_size(),this._set_image_ratio(),this._set_letterbox_mixin(),this._set_image_size(),this._set_cached_image_size(),this._set_crop_window_coordinates(),this._set_coordinate("origin")},_set_orientation_from_config:function(){return _.isString(this.config.orientation)?(this.orientation=orientation,void 0):this.img.width>=this.img.height?(this.orientation="landscape",void 0):(this.orientation="portrait",void 0)},_swap_orientation:function(){this.orientation="landscape"===this.orientation?"portrait":"landscape"},_init_letterbox:function(){this._set_mask_size.apply(this,arguments),this._reset_canvas_height_with_letterbox(),this._set_letterbox_coordinates()},_set_letterbox_mixin:function(){return this._set_raw_image_size(),this.image_size.width<this.canvas_size.width?(_.extend(this,letterbox.horizontal),this._init_letterbox(this.image_size.height,this.canvas_size.height),void 0):this.image_size.height<this.canvas_size.height?(_.extend(this,letterbox.vertical),this._init_letterbox(this.image_size.width,this.canvas_size.width),void 0):(_.extend(this,letterbox.none),void 0)},_set_cached_image_size:function(){this.cached_image_size=this.image_size},_set_image_ratio:function(){this.image_ratio=calculate_aspect_ratio(this.img.width,this.img.height)},_set_raw_image_size:function(){this.image_size={height:get_height_from_width(this.canvas_size.width,this.image_ratio),width:get_width_from_height(this.canvas_size.height,this.image_ratio)}},_set_mask_size:function(image_size,canvas_size){var mask_size=image_size-canvas_size;this.max_mask_size=mask_size>this.config.max_mask_size?this.config.max_mask_size:mask_size,this._set_half_mask_size()},_set_half_mask_size:function(){this.half_mask_size=Math.round(this.max_mask_size/2)},_set_aspect_ratio_from_config:function(){var aspect_ratio=this.config.aspect_ratio;if("string"!=typeof aspect_ratio)return!1;var ratio_array=aspect_ratio.split(":"),width=parseInt(ratio_array[0],10),height=parseInt(ratio_array[1],10);this.aspect_ratio="landscape"===this.orientation?calculate_aspect_ratio(width,height):calculate_aspect_ratio(height,width)},is_panning:!1,_set_img:function(img){this.img=img},_set_ctx:function(){this.ctx=this.el.getContext("2d")},_set_el:function(){this.$el=$("<canvas>"),this.el=this.$el[0]},_set_canvas_size:function(){this.canvas_size={width:this.config.width,height:get_height_from_width(this.config.width,this.aspect_ratio)},this.el.width=this.canvas_size.width,this.el.height=this.canvas_size.height},_set_coordinate:function(name,coordinate){this[name]=coordinate||{x:0,y:0}},_increment_origin:function(coorinate){this.origin.x+=coorinate.x||0,this.origin.y+=coorinate.y||0},on:function(event,el,callback){(el||this.el).addEventListener(event,callback||this,!1)},off:function(event,el,callback){(el||this.el).removeEventListener(event,callback||this,!1)},handleEvent:function(e){switch(e.preventDefault(),e.type){case"mousedown":this._on_mousedown(e);break;case"mousemove":this._on_mousemove(e);break;case"mouseup":case"mouseleave":case"mouseout":this._on_mouseup(e)}},_set_mouse_events:function(method){["mousedown","mousemove","mouseup","mouseleave"].forEach(function(event){this[method](event)},this),this[method]("mouseup",window)},draw:function(position){position=position||{x:0,y:0},this._fill_background(),this.ctx.drawImage(this.img,position.x,position.y,this.image_size.width,this.image_size.height),this._draw_letter_box()},_draw_letter_box:function(){return this.letterbox_coordinates?(this._draw_letter_box=function(){var mask=this.letterbox_coordinates;this._redraw_canvas(function(ctx){ctx.fillStyle="rgba(0,0,0,0.6)",ctx.fillRect.apply(ctx,mask[0]),ctx.fillRect.apply(ctx,mask[1])})},this._draw_letter_box(),void 0):(this._draw_letter_box=function(){},void 0)},_fill_background:function(){var canvas_size=this.canvas_size;this._redraw_canvas(function(ctx){ctx.fillStyle="rgba(255,255,255,1)",ctx.fillRect(0,0,canvas_size.width,canvas_size.height)})},_redraw_canvas:function(callback){var ctx=this.ctx;ctx.save(),ctx.setTransform(1,0,0,1,0,0),callback(ctx),ctx.restore()},get_mouse_position:function(e){return{x:e.layerX,y:e.layerY}},_set_start_position:function(e){this.start_position=this.get_mouse_position(e)},_on_mousedown:function(e){this._set_coordinate("_distance_moved"),this.is_panning=!0,this._set_start_position(e)},_on_mousemove:function(e){if(this.is_panning){var current_position=this.get_mouse_position(e),start_position=this.start_position;this._set_coordinate("_distance_moved",{x:current_position.x-start_position.x,y:current_position.y-start_position.y}),this.draw_with_rotation(this._distance_moved)}},_on_mouseup:function(){this.is_panning&&(this.is_panning=!1,this._update_translate_origin(this._distance_moved),this._snap_to_bounds())},coordiate_correction:function(image_dimension,top_left_offset,bottom_right_offset,origin_offset){var difference=image_dimension+origin_offset;return difference>image_dimension+top_left_offset?-origin_offset+top_left_offset:bottom_right_offset>difference?Math.round(bottom_right_offset-difference):0},_update_translate_origin:function(coordinate){this._increment_origin(coordinate),this.ctx.translate(coordinate.x,coordinate.y)},_snap_to_bounds:function(){var correction={x:this.coordiate_correction(this.image_size.width,this.crop_window[0],this.crop_window[2],this.origin.x),y:this.coordiate_correction(this.image_size.height,this.crop_window[1],this.crop_window[3],this.origin.y)};return 0===correction.x&&0===correction.y?!1:(this.draw_with_rotation(correction),this._update_translate_origin(correction),!0)},_is_smaller_than_crop_window:function(image_size){return image_size.height<this.crop_window[3]-this.crop_window[1]?!0:image_size.width<this.crop_window[2]-this.crop_window[0]?!0:!1},_modify_image_size:function(image_size){return this._is_smaller_than_crop_window(image_size)?!1:(this.image_size=image_size,void 0)},_perform_zoom:function(){var width=this.cached_image_size.width+this.zoom_amount*this.zoom_level,height=get_height_from_width(width,this.image_ratio);this._modify_image_size({width:width,height:height}),this._snap_to_bounds()||this.draw_with_rotation()},_increment_rotation_angle:function(){this.rotation_angle+=90,this.rotation_angle=this.rotation_angle>=360?0:this.rotation_angle},draw_with_rotation:function(position){return position=position||{x:0,y:0},0===this.rotation_angle?(this.draw(position),void 0):(this.ctx.save(),this.ctx.translate(this.image_size.width/2,this.image_size.height/2),this.ctx.rotate(this.rotation_angle*Math.PI/180),this.draw({x:position.x-this.image_size.width/2,y:position.y-this.image_size.height/2}),this.ctx.restore(),void 0)},actions:{zoomin:function(){++this.zoom_level,this._perform_zoom()},zoomout:function(){return 0>=this.zoom_level?!1:(--this.zoom_level,this._perform_zoom(),void 0)},done:function(){console.log("done")},redo:function(){this._increment_rotation_angle(),this.draw_with_rotation()},new_image:function(){console.log("new_image")},orientation:function(){this._swap_orientation(),this._set_common_properties(),this._perform_zoom(),this._snap_to_bounds()||this.draw_with_rotation()}}};var UI=function(){this.createEl(),this.render(),this.delegateEvents()};UI.fn=_.extend(UI.prototype,Eventable,{delegateEvents:function(){_.forEach(this.items,function(item){this.$el.delegate(".croppy__"+item,"click",this.dispatch_event.bind(this))},this)},items:["zoomin","zoomout","done","redo","new_image","orientation"],createEl:function(){this.$el=$("<div>",{"class":"croppy__ui"})},render:function(){var template="";return _.forEach(this.items,function(item){template+=this.template({action:item})},this),this.$el.html(template),this},dispatch_event:function(e){this.trigger("ui:"+e.target.dataset.action)},remove:function(){this.$el.undelegate().remove()},template:_.template('<a class="croppy-icon croppy__<%=action%>" data-action="<%=action%>"><%=action%></a>')}),window.Croppy=Croppy})(document);