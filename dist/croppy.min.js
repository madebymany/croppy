(function(document){var calculate_aspect_ratio=function(width,height){return height/width},get_height_from_width=function(width,aspect_ratio){return Math.round(width*aspect_ratio)},get_width_from_height=function(height,aspect_ratio){return Math.round(height/aspect_ratio)},scale=function(scale_factor,num){return Math.round(num*scale_factor)},Croppy=function(element,config){if(!this._can_cut_the_mustard())throw"Browser does not cut the mustard - cannot continue";this._set_el(element),this.config=_.extend({width:this.$el.width()},config)};_.extend(Croppy.prototype,Eventable,{readFromUrl:function(url){this._loadImage(url,!0)},readFromFile:function(files){var file=files[0];if(file.type.match("image.*")){var reader=new FileReader;reader.onload=function(e){this._loadImage(e.target.result)}.bind(this),reader.readAsDataURL(file)}},_render:function(img,config){this.ui=new UI,this.canvas=new InterfaceCanvas(img,config),this.$el.append(this.ui.$el,this.canvas.canvas.$el),this._addListeners()},_addListeners:function(){this.listenTo(this.canvas,"cropped",this.handle_cropped),_.forEach(this.ui.items,function(action){this.canvas.listenTo(this.ui,"ui:"+action,this.canvas.actions[action])},this)},_can_cut_the_mustard:function(){return window.FileReader?!0:!1},_loadImage:function(src,crossOrigin){var img=document.createElement("img");crossOrigin&&(img.crossOrigin="anonymous"),img.onload=function(){this._render(img,this.config)}.bind(this),img.src=src},_set_el:function(element){if(!element)throw"Parent dom container is not defined";this.$el=element instanceof $?element:$(element)},handle_cropped:function(data){this.config.on_crop&&this.config.on_crop.call(null,data),this.trigger("cropped",data)},detach:function(){this.canvas.canvas.$el.detach(),this.ui.$el.detach()},set_ui_enabled:function(boolean){this.ui.is_enabled=boolean}});var letterbox={horizontal:{_reset_canvas_height_with_letterbox:function(){this.canvas.set_height(this.canvas.get_height()+this.max_mask_size)},_set_image_size:function(){this.image_size={width:this.canvas.get_width(),height:this.image_size.height}},_set_letterbox_coordinates:function(){this.letterbox_coordinates=[[0,0,this.canvas.get_width(),this.half_mask_size],[0,this.canvas.get_height()-this.half_mask_size,this.canvas.get_width(),this.half_mask_size]]},_set_crop_window_coordinates:function(){this.crop_window=[0,this.half_mask_size,this.canvas.get_width(),this.canvas.get_height()-this.half_mask_size]}},vertical:{_reset_canvas_height_with_letterbox:function(){this.canvas.set_height(get_height_from_width(this.canvas.get_width()-this.max_mask_size,this.aspect_ratio))},_set_image_size:function(){this.image_size={width:get_width_from_height(this.canvas.get_height(),this.image_ratio),height:this.canvas.get_height()}},_set_letterbox_coordinates:function(){this.letterbox_coordinates=[[0,0,this.half_mask_size,this.canvas.get_height()],[this.canvas.get_width()-this.half_mask_size,0,this.half_mask_size,this.canvas.get_height()]]},_set_crop_window_coordinates:function(){this.crop_window=[this.half_mask_size,0,this.canvas.get_width()-this.half_mask_size,this.canvas.get_height()]}},none:{_set_crop_window_coordinates:function(){this.crop_window=[0,0,this.canvas.get_width(),this.canvas.get_height()]},_set_image_size:function(){}}},Canvas=function(){this._set_el(),this._set_ctx()};Canvas.prototype={_set_el:function(){this.$el=$("<canvas>"),this.el=this.$el[0]},translate:function(coordinate){this.ctx.translate(coordinate.x,coordinate.y)},_set_ctx:function(){this.ctx=this.el.getContext("2d")},set_width_and_height:function(width,aspect_ratio){this.set_width(width),this.set_height(get_height_from_width(width,aspect_ratio))},draw:function(position,img,image_size){position=position||{x:0,y:0},this._fill_background(),this.ctx.drawImage(img,position.x,position.y,image_size.width,image_size.height)},get_width:function(){return this.width},get_height:function(){return this.height},set_width:function(width){this.width=this.el.width=width},set_height:function(height){this.height=this.el.height=height},rotate_and_draw:function(position,img,image_size,rotation_angle){this.ctx.save(),this.ctx.translate(image_size.width/2,image_size.height/2),this.ctx.rotate(rotation_angle*Math.PI/180),position={x:position.x-image_size.width/2,y:position.y-image_size.height/2},this.draw(position,img,image_size),this.ctx.restore()},_fill_background:function(){this.redraw(function(ctx){ctx.fillStyle="rgba(255,255,255,1)",ctx.fillRect(0,0,this.get_width(),this.get_height())},this)},redraw:function(callback,scope){var ctx=this.ctx;ctx.save(),ctx.setTransform(1,0,0,1,0,0),callback.call(scope,ctx),ctx.restore()}};var InterfaceCanvas=function(img,config){this.config=_.extend(this.config,config),window.croppy=this,this.zoom_level=0,this.rotation_angle=0,this._set_img(img),this._set_orientation_from_config(),this._set_canvas(),this._set_common_properties(),this._set_mouse_events("addEvent"),this.draw_to_canvas(this.origin)};_.extend(InterfaceCanvas.prototype,Eventable,{zoom_amount:10,config:{aspect_ratio:"16:9",max_mask_size:160},_set_canvas:function(){this.canvas=new Canvas,this.crop_canvas=new Canvas},_set_common_properties:function(){this._get_aspect_ratio_from_config(),this.canvas.set_width_and_height(this.config.width,this.aspect_ratio),this._set_image_ratio(),this._set_letterbox_mixin(),this.letterbox._set_image_size.call(this),this._set_cached_image_size(),this.letterbox._set_crop_window_coordinates.call(this),this._set_coordinate("origin")},_set_orientation_from_config:function(){var has_orientation=_.contains(["landscape","portrait"],this.config.orientation);return has_orientation?(this.orientation=this.config.orientation,void 0):this.img.width>=this.img.height?(this.orientation="landscape",void 0):(this.orientation="portrait",void 0)},_swap_orientation:function(){this.orientation="landscape"===this.orientation?"portrait":"landscape"},_init_letterbox:function(){this._set_mask_size.apply(this,arguments),this.letterbox._reset_canvas_height_with_letterbox.call(this),this.letterbox._set_letterbox_coordinates.call(this)},_set_letterbox_mixin:function(){return this._set_raw_image_size(),this.image_size.width<this.canvas.get_width()?(this.letterbox=letterbox.horizontal,this._init_letterbox(this.image_size.height,this.canvas.get_height()),void 0):this.image_size.height<this.canvas.get_height()?(this.letterbox=letterbox.vertical,this._init_letterbox(this.image_size.width,this.canvas.get_width()),void 0):(this.letterbox=letterbox.none,void 0)},_set_cached_image_size:function(){this.cached_image_size=this.image_size},_set_image_ratio:function(){this.image_ratio=calculate_aspect_ratio(this.img.width,this.img.height)},_set_raw_image_size:function(){this.image_size={height:get_height_from_width(this.canvas.get_width(),this.image_ratio),width:get_width_from_height(this.canvas.get_height(),this.image_ratio)}},_set_mask_size:function(image_size,canvas_size){var mask_size=image_size-canvas_size;this.max_mask_size=mask_size>this.config.max_mask_size?this.config.max_mask_size:mask_size,this._set_half_mask_size()},_set_half_mask_size:function(){this.half_mask_size=Math.round(this.max_mask_size/2)},_get_aspect_ratio_from_config:function(){var aspect_ratio=this.config.aspect_ratio;return"string"!=typeof aspect_ratio?!1:(aspect_ratio=aspect_ratio.split(":"),this._set_aspect_ratio(parseInt(aspect_ratio[0],10),parseInt(aspect_ratio[1],10)),void 0)},_set_aspect_ratio:function(width,height){this.aspect_ratio="landscape"===this.orientation?calculate_aspect_ratio(width,height):calculate_aspect_ratio(height,width)},is_panning:!1,_set_img:function(img){this.img=img},_set_coordinate:function(name,coordinate){this[name]=coordinate||{x:0,y:0}},_increment_origin:function(coorinate){this.origin.x+=coorinate.x||0,this.origin.y+=coorinate.y||0},addEvent:function(event){this.canvas.el.addEventListener(event,this,!1)},removeEvent:function(event){this.canvas.el.removeEventListener(event,this,!1)},handleEvent:function(e){switch(e.preventDefault(),e.type){case"mousedown":this._on_mousedown(e);break;case"mousemove":this._on_mousemove(e);break;case"mouseup":case"mouseleave":case"mouseout":this._on_mouseup(e)}},_set_mouse_events:function(method){["mousedown","mousemove","mouseup","mouseleave"].forEach(this[method],this),this[method]("mouseup",window)},_draw_letter_box:function(){return this.letterbox_coordinates?(this._draw_letter_box=function(){this.canvas.redraw(function(ctx){ctx.fillStyle="rgba(0,0,0,0.6)",ctx.fillRect.apply(ctx,this.letterbox_coordinates[0]),ctx.fillRect.apply(ctx,this.letterbox_coordinates[1])},this)},this._draw_letter_box(),void 0):(this._draw_letter_box=function(){},void 0)},get_mouse_position:function(e){return{x:e.layerX,y:e.layerY}},_set_start_position:function(e){this.start_position=this.get_mouse_position(e)},_on_mousedown:function(e){this._set_coordinate("_distance_moved"),this.is_panning=!0,this._set_start_position(e)},_on_mousemove:function(e){if(this.is_panning){var current_position=this.get_mouse_position(e),start_position=this.start_position;this._set_coordinate("_distance_moved",{x:current_position.x-start_position.x,y:current_position.y-start_position.y}),this.draw_to_canvas(this._distance_moved)}},_on_mouseup:function(){this.is_panning&&(this.is_panning=!1,this._update_translate_origin(this._distance_moved),this._snap_to_bounds())},coordiate_correction:function(image_dimension,top_left_offset,bottom_right_offset,origin_offset){var difference=image_dimension+origin_offset;return difference>image_dimension+top_left_offset?-origin_offset+top_left_offset:bottom_right_offset>difference?Math.round(bottom_right_offset-difference):0},_update_translate_origin:function(coordinate){this._increment_origin(coordinate),this.canvas.translate(coordinate)},_snap_to_bounds:function(){var correction={x:this.coordiate_correction(this.image_size.width,this.crop_window[0],this.crop_window[2],this.origin.x),y:this.coordiate_correction(this.image_size.height,this.crop_window[1],this.crop_window[3],this.origin.y)};return 0===correction.x&&0===correction.y?!1:(this.draw_to_canvas(correction),this._update_translate_origin(correction),!0)},_is_smaller_than_crop_window:function(image_size){return image_size.height<this.crop_window[3]-this.crop_window[1]?!0:image_size.width<this.crop_window[2]-this.crop_window[0]?!0:!1},_modify_image_size:function(image_size){return this._is_smaller_than_crop_window(image_size)?!1:(this.image_size=image_size,void 0)},_perform_zoom:function(){var width=this.cached_image_size.width+this.zoom_amount*this.zoom_level,height=get_height_from_width(width,this.image_ratio);this._modify_image_size({width:width,height:height}),this._snap_to_bounds()||this.draw_to_canvas()},_increment_rotation_angle:function(){this.rotation_angle+=90,this.rotation_angle=this.rotation_angle>=360?0:this.rotation_angle},draw_to_canvas:function(position){position=position||{x:0,y:0},this.canvas[this.rotation_angle?"rotate_and_draw":"draw"](position,this.img,this.image_size,this.rotation_angle),this._draw_letter_box()},crop:function(){var crop_scale=_.partial(scale,this.img.width/this.image_size.width),canvas=new Canvas,crop_window=_.map(this.crop_window,crop_scale,this),position={x:crop_scale(this.origin.x)-crop_window[0],y:crop_scale(this.origin.y)-crop_window[1]};return canvas.set_width(crop_window[2]-crop_window[0]),canvas.set_height(crop_window[3]-crop_window[1]),canvas.draw(position,this.img,this.img),canvas.el.toDataURL("image/jpeg")},actions:{zoomin:function(){++this.zoom_level,this._perform_zoom()},zoomout:function(){return 0>=this.zoom_level?!1:(--this.zoom_level,this._perform_zoom(),void 0)},done:function(){var image=document.createElement("img");image.src=this.crop(),this.trigger("cropped",this.crop())},rotate:function(){this._increment_rotation_angle(),this.draw_to_canvas()},orientation:function(){this._swap_orientation(),this._set_common_properties(),this._perform_zoom(),this._snap_to_bounds()||this.draw_to_canvas()}}});var UI=function(){this.createEl(),this.render(),this.delegateEvents()};UI.fn=_.extend(UI.prototype,Eventable,{is_enabled:!0,delegateEvents:function(){_.forEach(this.items,function(item){this.$el.delegate(".croppy__"+item,"click",this.dispatch_event.bind(this))},this)},items:["zoomin","zoomout","done","rotate","orientation"],createEl:function(){this.$el=$("<div>",{"class":"croppy__ui"})},render:function(){var template="";return _.forEach(this.items,function(item){template+=this.template({action:item})},this),this.$el.html(template),this},dispatch_event:function(e){this.is_enabled&&this.trigger("ui:"+e.target.dataset.action)},remove:function(){this.$el.undelegate().remove()},template:_.template('<a class="croppy-icon croppy__<%=action%>" data-action="<%=action%>"><%=action%></a>')}),window.Croppy=Croppy})(document);