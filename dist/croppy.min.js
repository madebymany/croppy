(function(document){var extend=function(base){var args=[].splice.call(arguments,1);return[].forEach.call(args,function(obj){if(null!=obj)for(var o in obj)obj.hasOwnProperty(o)&&(base[o]=obj[o])}),base},create=function(protoProps,staticProps){var parent=this,child=function(){parent.apply(this,arguments)};return extend(child,parent,staticProps),child.prototype=Object.create(parent.prototype),protoProps&&extend(child.prototype,protoProps),child},Croppy=function(files,config){if(!window.FileReader)throw"Browser does not support fileReader - cannot continue";extend(this.config,config),this._set_config_aspect_ratio(this.config.aspect_ratio),this._set_config_dom_container(this.config.dom_container),this.Image=Image.create(this.config),[].forEach.call(files,function(file){file.type.match("image.*")&&this._readFile(file)},this)};Croppy.prototype={config:{ui_dimensions:{width:1e3,height:1e3},min_dimensions:{width:1e3,height:1e3},aspect_ratio:"16:9",max_letterbox_height:40,dom_container:"preview"},imageList:[],_set_config_dom_container:function(dom_container){if("string"==typeof dom_container&&(dom_container=document.getElementById(dom_container)),!dom_container||1!==dom_container.nodeType)throw"Parent dom container is not defined";return this.config.dom_container=dom_container},_set_config_aspect_ratio:function(aspect_ratio){return null==aspect_ratio?!1:(aspect_ratio&&"string"==typeof aspect_ratio&&(aspect_ratio=aspect_ratio.split(":"),aspect_ratio={width:parseInt(aspect_ratio[0],10),height:parseInt(aspect_ratio[1],10)}),this.config.aspect_ratio=aspect_ratio)},_readFile:function(file){if(!window.FileReader)throw"Browser does not support fileReader - cannot continue";var reader=new FileReader;reader.onload=this._onFileLoaded.bind(this),reader.readAsDataURL(file)},_onFileLoaded:function(e){var img=document.createElement("img");img.src=e.target.result,img.onload=function(){console.log(new this.Image(img))}.bind(this)}};var Canvas=function(dimensions,aspect_ratio,img){return this._set_canvas_el(),this._set_ctx(),this._set_origin(),this._set_img(img),this.canvas_el.width=dimensions.width,this.canvas_el.height=dimensions.height,this._set_mouse_events("on"),this.draw(this.origin),this};Canvas.prototype={is_panning:!1,_set_img:function(img){this.img=img},get_img:function(){return this.img},_set_ctx:function(){this.ctx=this.canvas_el.getContext("2d")},get_ctx:function(){return this.ctx},_set_canvas_el:function(){this.canvas_el=document.createElement("canvas")},get_canvas_el:function(){return this.canvas_el},_set_origin:function(origin){this.origin=null!=origin?origin:{x:0,y:0}},get_origin:function(){return this.origin},on:function(event,el,callback){console.log(isNaN(el)&&el||this.get_canvas_el(),event,callback||this),(el||this.get_canvas_el()).addEventListener(event,callback||this,!1)},off:function(event,el,callback){(el||this.get_canvas_el()).removeEventListener(event,callback||this,!1)},handleEvent:function(e){switch(e.preventDefault(),e.type){case"mousedown":this._on_mousedown(e);break;case"mousemove":this._on_mousemove(e);break;case"mouseup":case"mouseleave":case"mouseout":this._on_mouseup(e)}},_set_mouse_events:function(method){["mousedown","mousemove","mouseup","mouseleave"].forEach(function(event){this[method](event)},this),this[method]("mouseup",window)},draw:function(position){position=position||{x:0,y:0};var canvas=this.get_canvas_el(),ctx=this.get_ctx();ctx.drawImage(this.get_img(),position.x,position.y,canvas.width,canvas.height)},_fill_background:function(ctx,width,height){ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.fillStyle="rgba(255,255,255,1)",ctx.fillRect(0,0,width,height),ctx.restore()},get_mouse_position:function(e){return{x:e.layerX,y:e.layerY}},_set_start_position:function(e){this.start_position=this.get_mouse_position(e)},get_start_position:function(){return this.start_position},_on_mousedown:function(e){console.log("lol"),this.is_panning=!0,this._set_start_position(e)},_on_mousemove:function(e){if(console.log("mousemove"),this.is_panning){var current_position=this.get_mouse_position(e),start_position=this.get_start_position();this._set_origin({x:current_position.x-start_position.x,y:current_position.y-start_position.y}),this.draw(this.get_origin())}},_on_mouseup:function(){this.is_panning&&(this.is_panning=!1,this._check_bounds())},_calculate_correction:function(scale_offset,canvas_offset,origin){var difference=scale_offset+origin.y;return difference>scale_offset?-origin:scale_offset>difference?canvas_offset-difference:void 0},_check_bounds:function(){var image=this.get_img(),canvas=this.get_canvas_el();origin=this.get_origin(),x_correction=this._calculate_correction(image.width,canvas.width,origin.x),y_correction=this._calculate_correction(image.height,canvas.height,origin.y),0!==x_correction&&0!==y_correction&&(this.origin.x+=x_correction,this.origin.y+=y_correction,this.draw(this.origin)),this.get_ctx().translate(this.origin.x,this.origin.y)}};var Image=function(img){return this.img=img,this.aspect_ratio.hasOwnProperty("width")&&this.aspect_ratio.hasOwnProperty("height")||(this.aspect_ratio={width:img.width,heiht:img.height}),this._set_orientaion(),this.ui_scale={width:1e3,height:1e3},this.canvas=new Canvas(img,this.aspect_ratio,img),this.dom_container.appendChild(this.canvas.get_canvas_el()),this};Image.prototype={_set_orientaion:function(){return this.orientation=this.aspect_ratio[0]>=this.aspect_ratio[1]?"landscape":"portrait"},get_relative_dimensions_from_height:function(width){return this.aspect_ratio[1]/this.aspect_ratio[0]*width},get_relative_dimensions_from_width:function(height){return this.aspect_ratio[0]/this.aspect_ratio[1]*height},enforce_img_min_size:function(dimensions,img){if(img.width<dimensions.width||img.height<Math.floor(this.aspect_ratio*this.max_width)){var scale=this.set_scale(this.max_width,img,!1,!1);console.log(img.width,img.height),img.width=scale.width,img.height=scale.height,console.log(img.width,img.height)}},set_scale:function(max,obj,limit,checkScale){var width=obj.width,height=obj.height,scale=Math.min(max/width,height),minHeight=~~(.5625*max);return scale=limit&&scale>1?1:scale,width=parseInt(width*scale,10),height=parseInt(height*scale,10),!checkScale&&minHeight>height&&(width=minHeight/height*width,height=minHeight),{width:Math.round(width),height:Math.round(height)}}},Image.prototype.ui={initUi:function(){},createUIElement:function(canvas,name,text,pos){var el=document.createElement("a");el.textContent=text,el.dataset.ui=name,el.className=name+" crop-ui",el.addEventListener("click",this,!1),el.style[pos]=("zoomout"===name?canvas.maskHeight+30:canvas.maskHeight+10)+"px",canvas.parent.insertBefore(el,canvas.canvas)}},Image.create=create,window.Croppy=Croppy})(document);