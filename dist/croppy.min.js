(function(document){var DEFAULT_TEXT="Write your headline here";this.JST=this.JST||{},this.JST["src/templates/button.jst"]=function(obj){obj||(obj={});var __p="";with(_.escape,Array.prototype.join,obj)__p+='<div class="croppy__actions">\n  <div class="croppy__zoom croppy__action">\n    <a class="croppy-icon croppy__zoomin js-croppy-btn" data-action="zoomin">zoomin</a>\n    <a class="croppy-icon croppy__zoomout js-croppy-btn" data-action="zoomout">zoomout</a>\n    <span class="croppy__action__label">Zoom</span>\n  </div>\n\n  <div class="croppy__rotate croppy__action">\n    <a class="croppy-icon croppy__rotate js-croppy-btn" data-action="rotate">rotate</a>\n    <span class="croppy__action__label">Rotate</span>\n  </div>\n\n  ',"undefined"!=typeof enable_aspect_ratio&&enable_aspect_ratio&&(__p+='\n  <div class="croppy__zoom croppy__action">\n    <a class="croppy-icon croppy__16-x-9 js-croppy-btn" data-action="16:9">16:9</a>\n    <a class="croppy-icon croppy__4-x-3 js-croppy-btn" data-action="4:3">4:3</a>\n    <a class="croppy-icon croppy__1-x-1 js-croppy-btn" data-action="1:1">1:1</a>\n    <span class="croppy__action__label">Image ratio</span>\n  </div>\n  '),__p+='\n\n  <div class="croppy__text croppy__action">\n    <a class="croppy-icon croppy__text js-croppy-btn" data-action="text">croppytext</a>\n    <span class="croppy__action__label">Text</span>\n  </div>\n\n  <div class="croppy__save croppy__action">\n    <a class="croppy-icon croppy__done js-croppy-btn" data-action="done">done</a>\n    <span class="croppy__action__label">Save</span>\n  </div>\n</div>\n';return __p},this.JST["src/templates/text.jst"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+='<div class="croppy-text">\n  <div class="croppy-text__right">\n    <fieldset class="croppy-text__controls">\n      <legend class="croppy-text__label">Alignment</legend>\n        <input class="croppy-text__control" id="croppy_align_left" type="radio" checked name="alignment" value="left" />\n        <label for="croppy_align_left" class="croppy-text__btn">left</label>\n        <input class="croppy-text__control" id="croppy_align_center" type="radio" name="alignment" value="center" />\n        <label for="croppy_align_center" class="croppy-text__btn">center</label>\n        <input class="croppy-text__control" id="croppy_align_right" type="radio" name="alignment" value="right" />\n        <label for="croppy_align_right" class="croppy-text__btn">right</label>\n    </fieldset>\n    <fieldset class="croppy-text__controls">\n      <legend class="croppy-text__label">Distribution</legend>\n        <input class="croppy-text__control" id="croppy_dist_top" type="radio" name="distribution" value="top" />\n        <label for="croppy_dist_top" class="croppy-text__btn">top</label>\n        <input class="croppy-text__control" id="croppy_dist_middle" type="radio" name="distribution" value="middle" />\n        <label for="croppy_dist_middle" class="croppy-text__btn">middle</label>\n        <input class="croppy-text__control" id="croppy_dist_bottom" type="radio" checked name="distribution" value="bottom" />\n        <label for="croppy_dist_bottom" class="croppy-text__btn">bottom</label>\n    </fieldset>\n  </div>\n  <div class="croppy-text__left">\n    <label for="croppy_text_headline" class="croppy-text__label">Headline</label>\n    <textarea id="croppy_text_headline" class="js-croppy-headline">'+(null==(__t=default_text)?"":__t)+"</textarea>\n  </div>\n </div>\n\n";return __p};var calculate_aspect_ratio=function(width,height){return height/width},get_height_from_width=function(width,aspect_ratio){return Math.round(width*aspect_ratio)},get_width_from_height=function(height,aspect_ratio){return Math.round(height/aspect_ratio)},scale=function(scale_factor,num){return Math.round(num*scale_factor)},Croppy=function(element,config){if(!this._can_cut_the_mustard())throw"Browser does not cut the mustard - cannot continue";this._set_el(element),this.config=_.extend({width:this.$el.width()},config)};_.extend(Croppy.prototype,Eventable,{readFromUrl:function(url){this._loadImage(url,!0)},readFromFile:function(files){var file=files[0];if(file.type.match("image.*")){var reader=new FileReader;reader.onload=function(e){this._loadImage(e.target.result)}.bind(this),reader.readAsDataURL(file)}},_render:function(img,config){this.ui=new UI(config),this.canvas=new InterfaceCanvas(img,config),this.$el.append(this.ui.$el,this.canvas.canvas.$el),this._addListeners()},_addListeners:function(){this.listenTo(this.canvas,"cropped",this.handle_cropped),_.forEach(this.ui.items,function(action){this.canvas.listenTo(this.ui,"ui:"+action,this.canvas.actions[action])},this),this.canvas.listenTo(this.ui,"ui:text:input",this.canvas.handle_text_input),this.canvas.listenTo(this.ui,"ui:text:action",this.canvas.handle_text_action)},_can_cut_the_mustard:function(){return window.FileReader?!0:!1},_loadImage:function(src,crossOrigin){var img=document.createElement("img");crossOrigin&&(img.crossOrigin="anonymous"),img.onload=function(){this._render(img,this.config)}.bind(this),img.src=src},_set_el:function(element){if(!element)throw"Parent dom container is not defined";this.$el=element instanceof $?element:$(element)},handle_cropped:function(data){this.config.on_crop&&this.config.on_crop.call(null,data),this.trigger("cropped",data)},detach:function(){this.canvas.canvas.$el.detach(),this.ui.$el.detach()},set_ui_enabled:function(boolean){this.ui.is_enabled=boolean}});var letterbox={horizontal:{_reset_canvas_height_with_letterbox:function(){this.canvas.set_height(this.canvas.get_height()+this.max_mask_size)},_set_image_size:function(){this.image_size={width:this.canvas.get_width(),height:this.image_size.height}},_set_letterbox_coordinates:function(){this.letterbox_coordinates=[[0,0,this.canvas.get_width(),this.half_mask_size],[0,this.canvas.get_height()-this.half_mask_size,this.canvas.get_width(),this.half_mask_size]]},_set_crop_window_coordinates:function(){this.crop_window=[0,this.half_mask_size,this.canvas.get_width(),this.canvas.get_height()-this.half_mask_size]}},vertical:{_reset_canvas_height_with_letterbox:function(){this.canvas.set_height(get_height_from_width(this.canvas.get_width()-this.max_mask_size,this.aspect_ratio))},_set_image_size:function(){this.image_size={width:get_width_from_height(this.canvas.get_height(),this.image_ratio),height:this.canvas.get_height()}},_set_letterbox_coordinates:function(){this.letterbox_coordinates=[[0,0,this.half_mask_size,this.canvas.get_height()],[this.canvas.get_width()-this.half_mask_size,0,this.half_mask_size,this.canvas.get_height()]]},_set_crop_window_coordinates:function(){this.crop_window=[this.half_mask_size,0,this.canvas.get_width()-this.half_mask_size,this.canvas.get_height()]}},none:{_set_crop_window_coordinates:function(){this.crop_window=[0,0,this.canvas.get_width(),this.canvas.get_height()]},_reset_canvas_height_with_letterbox:function(){},_set_image_size:function(){},_set_letterbox_coordinates:function(){this.letterbox_coordinates=void 0}}},Canvas=function(config){this.font_family=config.font_family||"Arial",this._loadBackground(config.background),this._set_el(),this._set_ctx()};Canvas.prototype={_set_el:function(){this.$el=$("<canvas>"),this.el=this.$el[0]},translate:function(coordinate){this.ctx.translate(coordinate.x,coordinate.y)},_set_ctx:function(){this.ctx=this.el.getContext("2d")},set_width_and_height:function(width,aspect_ratio){this.set_width(width),this.set_height(get_height_from_width(width,aspect_ratio))},draw:function(position,img,image_size){position=position||{x:0,y:0},this._fill_background(),this.ctx.drawImage(img,position.x,position.y,image_size.width,image_size.height)},get_width:function(){return this.width},get_height:function(){return this.height},set_width:function(width){this.width=this.el.width=width},set_height:function(height){this.height=this.el.height=height},rotate_and_draw:function(position,img,image_size,rotation){this.ctx.save(),this.ctx.translate(image_size.width/2,image_size.height/2),this.ctx.rotate(rotation*Math.PI/180),this.ctx.translate(-(image_size.width/2),-(image_size.height/2)),this.draw(position,img,image_size),this.ctx.restore()},_loadBackground:function(background){if(this.background="rgba(255,255,255,1)",background){var img=new Image;img.crossOrigin="use-credentials";var _this=this;img.onload=function(){_this.background=_this.ctx.createPattern(img,"repeat")},img.src=background}},_fill_background:function(){this.redraw(function(ctx){ctx.fillStyle=this.background,ctx.fillRect(0,0,this.get_width(),this.get_height())},this)},redraw:function(callback,scope){var ctx=this.ctx;ctx.save(),ctx.setTransform(1,0,0,1,0,0),callback.call(scope,ctx),ctx.restore()},render_overlay:function(){this.redraw(function(ctx){ctx.globalAlpha=.3,ctx.fillStyle="#000",ctx.fillRect(0,0,this.get_width(),this.get_height()),ctx.globalAlpha=1},this)},calculate_offset:function(dimension,a,b){return Math.round((dimension-(a-b))/2)},render_text:function(text,distribution,alignment,crop_window,scaleFn){this.render_overlay(),this.redraw(function(ctx){var fontSize=scaleFn?scaleFn(18):18,lineHeight=Math.round(1.7*fontSize),padding=Math.round(1.2*fontSize),width=this.get_width(),height=this.get_height(),x_letterbox_offset=crop_window?this.calculate_offset(width,crop_window[2],crop_window[0]):0,y_letterbox_offset=crop_window?this.calculate_offset(height,crop_window[3],crop_window[1]):0,maxWidth=Math.round(width-2*x_letterbox_offset-2*padding),x=x_letterbox_offset,y=y_letterbox_offset;ctx.font=fontSize+"pt "+this.font_family,ctx.fillStyle="#fff",ctx.textBaseline="middle",ctx.shadowColor="#000000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=scaleFn?scaleFn(1):1,ctx.shadowBlur=scaleFn?scaleFn(1):1,"center"===alignment?(ctx.textAlign="center",x=width/2):"right"===alignment?(ctx.textAlign="right",x=width-x_letterbox_offset-padding):(ctx.textAlign="left",x=x_letterbox_offset+padding);var paras=text.split(/\r?\n|\r/g);paras=paras.map(function(para){for(var line="",lines=[],words=para.split(" "),n=0;words.length>n;n++){var testLine=line+words[n]+" ",metrics=ctx.measureText(testLine),testWidth=metrics.width;testWidth>maxWidth&&n>0?(lines.push(line.trim()),line=words[n]+" "):line=testLine}return lines.push(line.trim()),lines});var lineBreaks=paras.reduce(function(memo,para){return memo+para.length},-1),heightOffset=lineHeight*lineBreaks;y="top"===distribution?y_letterbox_offset+(padding+lineHeight/2):"middle"===distribution?Math.round((height-heightOffset)/2):height-y_letterbox_offset-(padding+lineHeight/2)-heightOffset,paras.forEach(function(para){para.forEach(function(line){ctx.fillText(line,x,y),y+=lineHeight})}),ctx.shadowColor="transparent"},this)}};var InterfaceCanvas=function(img,config){this.config=_.extend(this.config,config),window.croppy=this,this.zoom_level=0,this.rotation_angle=0,this._set_img(img),this._set_orientation_from_config(),this._set_canvas(),this._set_aspect_ratio(this.config.aspect_ratio),this._set_common_properties(),this._set_mouse_events("addEvent"),this.draw_to_canvas(this.origin),this.on()};_.extend(InterfaceCanvas.prototype,Eventable,{zoom_amount:10,config:{aspect_ratio:"16:9",max_mask_size:160},_set_canvas:function(){this.canvas=new Canvas(this.config),this.crop_canvas=new Canvas(this.config)},_set_common_properties:function(){this.canvas.set_width_and_height(this.config.width,this.aspect_ratio),this._set_image_ratio(),this._set_letterbox_mixin(),this.letterbox._set_image_size.call(this),this._set_cached_image_size(),this.letterbox._set_crop_window_coordinates.call(this),this._set_coordinate("origin")},_set_orientation_from_config:function(){var has_orientation=_.contains(["landscape","portrait"],this.config.orientation);return has_orientation?(this.orientation=this.config.orientation,void 0):this.img.width>=this.img.height?(this.orientation="landscape",void 0):(this.orientation="portrait",void 0)},_swap_orientation:function(){this.orientation="landscape"===this.orientation?"portrait":"landscape"},_init_letterbox:function(){this._set_mask_size.apply(this,arguments),this.letterbox._reset_canvas_height_with_letterbox.call(this),this.letterbox._set_letterbox_coordinates.call(this)},_set_letterbox_mixin:function(){return this._set_raw_image_size(),this.image_size.width<this.canvas.get_width()?(this.letterbox=letterbox.horizontal,this._init_letterbox(this.image_size.height,this.canvas.get_height()),void 0):this.image_size.height<this.canvas.get_height()?(this.letterbox=letterbox.vertical,this._init_letterbox(this.image_size.width,this.canvas.get_width()),void 0):(this.letterbox=letterbox.none,this._init_letterbox(0,0),void 0)},_set_cached_image_size:function(){this.cached_image_size=this.image_size},_set_image_ratio:function(){this.image_ratio=calculate_aspect_ratio(this.img.width,this.img.height)},_set_raw_image_size:function(){this.image_size={height:get_height_from_width(this.canvas.get_width(),this.image_ratio),width:get_width_from_height(this.canvas.get_height(),this.image_ratio)}},_set_mask_size:function(image_size,canvas_size){var mask_size=image_size-canvas_size;this.max_mask_size=mask_size>this.config.max_mask_size?this.config.max_mask_size:mask_size,this._set_half_mask_size()},_set_half_mask_size:function(){this.half_mask_size=Math.round(this.max_mask_size/2)},_get_aspect_ratio_from_config:function(){},_set_aspect_ratio:function(aspect_ratio){if("string"!=typeof aspect_ratio)return!1;aspect_ratio=aspect_ratio.split(":");var width=parseInt(aspect_ratio[0],10),height=parseInt(aspect_ratio[1],10);this.aspect_ratio="landscape"===this.orientation?calculate_aspect_ratio(width,height):calculate_aspect_ratio(height,width)},is_panning:!1,_set_img:function(img){this.img=img},_set_coordinate:function(name,coordinate){this[name]=coordinate||{x:0,y:0}},_increment_origin:function(coorinate){this.origin.x+=coorinate.x||0,this.origin.y+=coorinate.y||0},addEvent:function(event){this.canvas.el.addEventListener(event,this,!1)},removeEvent:function(event){this.canvas.el.removeEventListener(event,this,!1)},handleEvent:function(e){switch(e.preventDefault(),e.type){case"mousedown":this._on_mousedown(e);break;case"mousemove":this._on_mousemove(e);break;case"mouseup":case"mouseleave":case"mouseout":this._on_mouseup(e)}},_set_mouse_events:function(method){["mousedown","mousemove","mouseup","mouseleave"].forEach(this[method],this),this[method]("mouseup",window)},_draw_letter_box:function(){this.letterbox_coordinates&&this.canvas.redraw(function(ctx){ctx.fillStyle="rgba(0,0,0,0.8)",ctx.fillRect.apply(ctx,this.letterbox_coordinates[0]),ctx.fillRect.apply(ctx,this.letterbox_coordinates[1])},this)},get_mouse_position:function(e){return{x:e.layerX,y:e.layerY}},_set_start_position:function(e){this.start_position=this.get_mouse_position(e)},_on_mousedown:function(e){this._set_coordinate("_distance_moved"),this.is_panning=!0,this._set_start_position(e)},_on_mousemove:function(e){if(this.is_panning){var current_position=this.get_mouse_position(e),start_position=this.start_position;this._set_coordinate("_distance_moved",{x:current_position.x-start_position.x,y:current_position.y-start_position.y}),this.draw_to_canvas(this._distance_moved)}},_on_mouseup:function(){this.is_panning&&(this.is_panning=!1,this._update_translate_origin(this._distance_moved),this._snap_to_bounds())},coordiate_correction:function(dimension,top_left_offset,bottom_right_offset,origin_offset){var image_dimension=this.image_size[dimension],canvas_dimension=this.canvas[dimension],difference=image_dimension+origin_offset;return bottom_right_offset-top_left_offset>image_dimension?(canvas_dimension-image_dimension)/2-origin_offset:difference>image_dimension+top_left_offset?-origin_offset+top_left_offset:bottom_right_offset>difference?Math.round(bottom_right_offset-difference):0},_update_translate_origin:function(coordinate){this._increment_origin(coordinate),this.canvas.translate(coordinate)},_snap_to_bounds:function(){var x=0,y=0;if(this.rotation_angle)return!1;if(x=this.coordiate_correction("width",this.crop_window[0],this.crop_window[2],this.origin.x),y=this.coordiate_correction("height",this.crop_window[1],this.crop_window[3],this.origin.y),!x&&!y)return!1;var correction={x:x,y:y};return this.draw_to_canvas(correction),this._update_translate_origin(correction),!0},_perform_zoom:function(){var width=this.cached_image_size.width+this.zoom_amount*this.zoom_level,height=get_height_from_width(width,this.image_ratio);this.image_size={width:width,height:height},this._snap_to_bounds()||this.draw_to_canvas()},_increment_rotation_angle:function(){this.rotation_angle+=90,this.rotation_angle=this.rotation_angle>=360?0:this.rotation_angle},_get_transformed_coords:function(position){if(!this.rotation_angle)return position;var radians=this.rotation_angle*Math.PI/180;return{x:Math.round(position.x*Math.cos(radians)+position.y*Math.sin(radians)),y:Math.round(-position.x*Math.sin(radians)+position.y*Math.cos(radians))}},draw_to_canvas:function(position){position=position||{x:0,y:0},this.canvas[this.rotation_angle?"rotate_and_draw":"draw"](this._get_transformed_coords(position),this.img,this.image_size,this.rotation_angle),this._draw_letter_box(),this.text&&this.canvas.render_text(this.text,this.distribution,this.alignment,this.crop_window)},crop:function(){var min_width=this.config.min_width||this.canvas.width,crop_size=this.img.width>=min_width?this.img:{width:min_width,height:get_height_from_width(min_width,this.image_ratio)},crop_scale=_.partial(scale,crop_size.width/this.image_size.width),crop_window=_.map(this.crop_window,crop_scale,this),position={x:crop_scale(this.origin.x)-crop_window[0],y:crop_scale(this.origin.y)-crop_window[1]};return this.crop_canvas.set_width(crop_window[2]-crop_window[0]),this.crop_canvas.set_height(crop_window[3]-crop_window[1]),this.crop_canvas[this.rotation_angle?"rotate_and_draw":"draw"](this._get_transformed_coords(position),this.img,crop_size,this.rotation_angle),this.text&&this.crop_canvas.render_text(this.text,this.distribution,this.alignment,null,crop_scale),this.crop_canvas.el.toDataURL("image/jpeg")},handle_text_input:function(data){this.text=data,this.draw_to_canvas()},handle_text_action:function(type,value){this[type]=value,this.draw_to_canvas()},reset:function(){this._set_common_properties(),this._perform_zoom(),this._snap_to_bounds()||this.draw_to_canvas()},actions:{zoomin:function(){++this.zoom_level,this._perform_zoom()},zoomout:function(){--this.zoom_level,this._perform_zoom()},done:function(){var image=document.createElement("img");image.src=this.crop(),this.trigger("cropped",this.crop())},rotate:function(){this._increment_rotation_angle(),this.draw_to_canvas({x:-(this.image_size.width/2),y:-(this.image_size.height/2)}),this.reset()},"16:9":function(){this._set_aspect_ratio("16:9"),this.reset()},"4:3":function(){this._set_aspect_ratio("4:3"),this.reset()},"1:1":function(){this._set_aspect_ratio("1:1"),this.reset()},orientation:function(){this._swap_orientation(),this.reset()}}});var UI=function(config){this.config=config||{},this.createEl(),this.render(),this.delegateEvents()};UI.fn=_.extend(UI.prototype,Eventable,{is_enabled:!0,delegateEvents:function(){this.$el.on("click",".js-croppy-btn",this.dispatch_event.bind(this)),this.$el.on("keyup",".js-croppy-headline",this.dispatch_text.bind(this)),this.$el.on("change",".croppy-text__control",this.dispatch_text_button.bind(this))},items:["zoomin","zoomout","done","rotate","orientation","text","16:9","4:3","1:1"],createEl:function(){this.$el=$("<div>",{"class":"croppy__ui"})},render:function(){return this.$el.html(JST["src/templates/button.jst"](this.config.ui)),this},dispatch_text:function(e){this.trigger("ui:text:input",e&&e.target.value)},dispatch_text_button:function(e){this.trigger("ui:text:action",e.target.name,e.target.value)},dispatch_event:function(e){var action=e.target.dataset.action;this.is_enabled&&this.trigger("ui:"+action),"text"===action&&this.toggle_text_ui()},toggle_text_ui:function(){var text_ui=this.$el.find(".croppy-text");text_ui.length?(this.dispatch_text(),text_ui.remove()):(this.$el.append(JST["src/templates/text.jst"]({default_text:DEFAULT_TEXT})),this.dispatch_text({target:{value:DEFAULT_TEXT}}))},remove:function(){this.$el.undelegate().remove()}}),window.Croppy=Croppy})(document);