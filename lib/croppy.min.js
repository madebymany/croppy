// Croppy, v0.1.1

(function(e){var t=function(e){var t=[].splice.call(arguments,1);return[].forEach.call(t,function(t){if(t==null)return;for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}),e},n=function(e,n){var r=this,i=function(){r.apply(this,arguments)};return t(i,r,n),i.prototype=Object.create(r.prototype),e&&t(i.prototype,e),i},r=function(e){return e&&e.constructor==Array},i=function(e,n){if(!window.FileReader)throw"Browser does not support fileReader - cannot continue";t(this.config,n),this._set_config_aspect_ratio(this.config.aspect_ratio),this._set_config_dom_container(this.config.dom_container),this.Image=o.create(this.config),[].forEach.call(e,function(e){e.type.match("image.*")&&this._readFile(e)},this)};i.prototype={config:{ui_dimensions:{width:1e3,height:1e3},min_dimensions:{width:1e3,height:1e3},aspect_ratio:"16:9",max_letterbox_height:40,dom_container:"preview"},imageList:[],_set_config_dom_container:function(t){typeof t=="string"&&(t=e.getElementById(t));if(!t||t.nodeType!==1)throw"Parent dom container is not defined";return this.config.dom_container=t},_set_config_aspect_ratio:function(e){return e==null?!1:(e&&typeof e=="string"&&(e=e.split(":"),e={width:parseInt(e[0],10),height:parseInt(e[1],10)}),this.config.aspect_ratio=e)},_readFile:function(e){if(!window.FileReader)throw"Browser does not support fileReader - cannot continue";var t=new FileReader;t.onload=this._onFileLoaded.bind(this),t.readAsDataURL(e)},_onFileLoaded:function(t){var n=e.createElement("img");n.src=t.target.result,n.onload=function(){console.log(new this.Image(n))}.bind(this)}};var s=function(e,t,n){return this._set_canvas_el(),this._set_ctx(),this._set_origin(),this._set_img(n),this.canvas_el.width=e.width,this.canvas_el.height=e.height,this._set_mouse_events("on"),this.draw(this.origin),this};s.prototype={is_panning:!1,_set_img:function(e){this.img=e},get_img:function(){return this.img},_set_ctx:function(){this.ctx=this.canvas_el.getContext("2d")},get_ctx:function(){return this.ctx},_set_canvas_el:function(){this.canvas_el=e.createElement("canvas")},get_canvas_el:function(){return this.canvas_el},_set_origin:function(e){this.origin=e!=null?e:{x:0,y:0}},get_origin:function(){return this.origin},on:function(e,t,n){console.log(isNaN(t)&&t||this.get_canvas_el(),e,n||this),(t||this.get_canvas_el()).addEventListener(e,n||this,!1)},off:function(e,t,n){(t||this.get_canvas_el()).removeEventListener(e,n||this,!1)},handleEvent:function(e){e.preventDefault(),console.log(e.type);switch(e.type){case"mousedown":this._on_mousedown(e);break;case"mousemove":this._on_mousemove(e);break;case"mouseup":case"mouseleave":case"mouseout":this._on_mouseup(e)}},_set_mouse_events:function(e){["mousedown","mousemove","mouseup","mouseleave"].forEach(function(t){console.log(e,t),this[e](t)},this),this[e]("mouseup",window)},draw:function(e){e=e||{x:0,y:0};var t=this.get_canvas_el(),n=this.get_ctx();this._fill_background(this.get_ctx(),t.width,t.height),n.drawImage(this.get_img(),e.x,e.y,t.width,t.height)},_fill_background:function(e,t,n){e.save(),e.setTransform(1,0,0,1,0,0),e.fillStyle="rgba(255,255,255,1)",e.fillRect(0,0,t,n),e.restore()},get_mouse_position:function(e){return{x:e.layerX,y:e.layerY}},_set_start_position:function(e){this.start_position=this.get_mouse_position(e)},get_start_position:function(e){return this.start_position},_on_mousedown:function(e){console.log("lol"),this.is_panning=!0,this._set_start_position(e)},_on_mousemove:function(e){console.log("mousemove");if(!this.is_panning)return;var t=this.get_mouse_position(e),n=this.get_start_position();this._set_origin({x:t.x-n.x,y:t.y-n.y}),this.draw(this.get_origin())},_on_mouseup:function(e){if(!this.is_panning)return;this.is_panning=!1,this._check_bounds()},_calculate_correction:function(e,t,n){var r=e+n.y;if(r>e)return-n;if(r<e)return t-r},_check_bounds:function(){var e=this.get_img(),t=this.get_canvas_el();origin=this.get_origin(),x_correction=this._calculate_correction(e.width,t.width,origin.x),y_correction=this._calculate_correction(e.height,t.height,origin.y),x_correction!==0&&y_correction!==0&&(this.origin.x+=x_correction,this.origin.y+=y_correction,this.draw(this.origin)),this.get_ctx().translate(this.origin.x,this.origin.y)}};var o=function(e){this.img=e;if(!this.aspect_ratio.hasOwnProperty("width")||!this.aspect_ratio.hasOwnProperty("height"))this.aspect_ratio={width:e.width,heiht:e.height};return this._set_orientaion(),this.ui_scale={width:1e3,height:1e3},this.canvas=new s(e,this.aspect_ratio,e),this.dom_container.appendChild(this.canvas.get_canvas_el()),this};o.prototype={_set_orientaion:function(){return this.aspect_ratio[0]>=this.aspect_ratio[1]?this.orientation="landscape":this.orientation="portrait"},get_relative_dimensions_from_height:function(e){return this.aspect_ratio[1]/this.aspect_ratio[0]*e},get_relative_dimensions_from_width:function(e){return this.aspect_ratio[0]/this.aspect_ratio[1]*e},enforce_img_min_size:function(e,t){if(t.width<e.width||t.height<Math.floor(this.aspect_ratio*this.max_width)){var n=this.set_scale(this.max_width,t,!1,!1);console.log(t.width,t.height),t.width=n.width,t.height=n.height,console.log(t.width,t.height)}},set_scale:function(e,t,n,r){var i=t.width,s=t.height,o=Math.min(e/i,s),u=~~(.5625*e);return o=n&&o>1?1:o,i=parseInt(i*o,10),s=parseInt(s*o,10),!r&&s<u&&(i=u/s*i,s=u),{width:Math.round(i),height:Math.round(s)}}};var u=o.prototype.ui={initUi:function(){},createUIElement:function(t,n,r,i){var s=e.createElement("a");s.textContent=r,s.dataset.ui=n,s.className=n+" crop-ui",s.addEventListener("click",this,!1),s.style[i]=(n==="zoomout"?t.maskHeight+30:t.maskHeight+10)+"px",t.parent.insertBefore(s,t.canvas)}};o.create=n,window.Croppy=i})(document);